<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ูุธุงู ุฅุฏุงุฑุฉ ุงููุฏููุนุงุช ุงููุทูุฑ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        [v-cloak] { display: none; }
        .loader { border-top-color: #3b82f6; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Mobile optimizations */
        @media (max-width: 640px) {
            .mobile-compact { padding: 1rem; }
            .mobile-text-sm { font-size: 0.875rem; }
            .mobile-gap-sm { gap: 0.5rem; }
        }
    </style>
</head>
<body class="min-h-screen bg-slate-50 p-2 sm:p-4">

<div id="app" v-cloak>
    <div class="max-w-6xl mx-auto mb-4 sm:mb-6">
        <div class="bg-white rounded-2xl sm:rounded-3xl shadow-sm border border-slate-200 p-4 sm:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0 mb-4 sm:mb-6">
                <div class="flex items-center gap-3">
                    <div :class="role === 'Admin' ? 'bg-red-500' : 'bg-blue-500'" class="p-2 sm:p-3 rounded-xl sm:rounded-2xl text-white shadow-lg">
                        <i :data-lucide="role === 'Admin' ? 'shield-check' : 'user'" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl sm:text-2xl font-black text-slate-800">ูุฏููุนุงุชู</h1>
                        <p class="text-slate-500 text-xs sm:text-sm font-bold">ููุญุฉ ุชุญูู {{ role === 'Admin' ? 'ุงููุฏูุฑ' : 'ุงููุณุชุฎุฏู' }}</p>
                    </div>
                </div>
                <button @click="toggleLogs" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 sm:px-5 sm:py-2.5 rounded-xl flex items-center gap-2 transition-all font-bold text-sm">
                    <i data-lucide="history" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                    ุงูุณุฌูุงุช
                </button>
            </div>
            
            <div class="bg-slate-900 rounded-2xl sm:rounded-3xl p-5 sm:p-8 text-white relative overflow-hidden shadow-2xl">
                <div class="relative z-10 flex flex-col items-center text-center gap-4 sm:gap-6 sm:flex-row sm:justify-between sm:text-right">
                    <div>
                        <p class="text-slate-400 font-bold mb-2 text-sm sm:text-base">ุฅุฌูุงูู ุงูุฑุตูุฏ ุงููุชุงุญ</p>
                        <p class="text-3xl sm:text-5xl font-black tracking-tight">{{ balance.toFixed(2) }} <span class="text-base sm:text-xl text-slate-400">ุฌููู</span></p>
                    </div>
                    <div class="flex flex-wrap justify-center gap-2 sm:gap-3" v-if="role === 'Admin'">
                        <button @click="showDepositModal = true" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 sm:px-6 sm:py-3 rounded-xl transition flex items-center gap-2 font-bold shadow-lg shadow-blue-900/20 text-sm">
                            <i data-lucide="plus-circle" class="w-4 h-4 sm:w-5 sm:h-5"></i> ุฅูุฏุงุน
                        </button>
                        <button @click="openEditBalance" class="bg-slate-800 hover:bg-slate-700 px-4 py-2 sm:px-6 sm:py-3 rounded-xl transition flex items-center gap-2 font-bold border border-slate-700 text-sm">
                            <i data-lucide="edit-3" class="w-4 h-4 sm:w-5 sm:h-5"></i> ุชุนุฏูู
                        </button>
                        <button @click="shareBalance" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 sm:px-6 sm:py-3 rounded-xl transition flex items-center gap-2 font-bold shadow-lg shadow-emerald-900/20 text-sm">
                            <i data-lucide="share-2" class="w-4 h-4 sm:w-5 sm:h-5"></i> ูุดุงุฑูุฉ
                        </button>
                    </div>
                </div>
                <div class="absolute -right-20 -bottom-20 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl"></div>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <div v-if="role === 'User'" class="mb-4 sm:mb-8">
            <button @click="openRequestModal()" class="w-full bg-white border-2 border-dashed border-blue-300 text-blue-600 px-4 py-6 sm:px-6 sm:py-8 rounded-2xl sm:rounded-3xl hover:bg-blue-50 hover:border-blue-400 transition-all flex items-center justify-center gap-2 sm:gap-3 text-lg sm:text-xl font-black shadow-sm">
                <i data-lucide="send" class="w-6 h-6 sm:w-8 sm:h-8"></i> ุฅูุดุงุก ุทูุจ ุชุญููู ุฌุฏูุฏ
            </button>
        </div>

        <!-- ูุณู ุงูููุถูุฉ - ูู ุงูุฃุนูู -->
        <div v-if="favorites.length > 0" class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl sm:rounded-3xl shadow-sm border-2 border-amber-200 p-4 sm:p-6 mb-4 sm:mb-6">
            <div class="flex justify-between items-center mb-3 sm:mb-4">
                <h2 class="text-lg sm:text-xl font-black text-slate-800 flex items-center gap-2">
                    <i data-lucide="star" class="text-amber-500 fill-current w-5 h-5"></i> 
                    <span class="hidden sm:inline">ุงูููุถูุฉ - ูุตูู ุณุฑูุน</span>
                    <span class="sm:hidden">ุงูููุถูุฉ</span>
                </h2>
                <button @click="showAllFavorites = !showAllFavorites" class="text-amber-600 text-xs sm:text-sm font-bold hover:text-amber-700 transition flex items-center gap-1">
                    <span>{{ showAllFavorites ? 'ุฅุฎูุงุก' : 'ุนุฑุถ ุงููู' }}</span>
                    <i :data-lucide="showAllFavorites ? 'chevron-up' : 'chevron-down'" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 gap-2 sm:gap-3" v-show="showAllFavorites || favorites.length <= 4">
                <div v-for="fav in (showAllFavorites ? favorites : favorites.slice(0, 4))" :key="fav.id" 
                    class="bg-white border-2 border-amber-100 rounded-xl sm:rounded-2xl p-3 sm:p-4 transition-all hover:shadow-md text-right">
                    
                    <div class="flex justify-between items-start gap-2">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-2">
                                <h3 class="text-sm sm:text-base font-black text-slate-800 truncate">{{ fav.teacherName }}</h3>
                                <button 
                                    @click="removeFavorite(fav.id)" 
                                    class="text-amber-400 hover:text-red-500 transition-colors flex-shrink-0"
                                    title="ุฅุฒุงูุฉ ูู ุงูููุถูุฉ">
                                    <i data-lucide="x-circle" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="flex flex-wrap gap-2 text-xs text-slate-500 font-bold">
                                <span class="flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> {{ fav.teacherNumber }}</span>
                                <span class="flex items-center gap-1"><i data-lucide="wallet" class="w-3 h-3 text-blue-500"></i> {{ fav.accountType === 'Insta' ? 'ุฅูุณุชุง' : 'ูุงุด' }}</span>
                                <span class="text-blue-600 font-black">{{ fav.value }} ุฌ</span>
                            </div>
                        </div>

                        <button 
                            v-if="role === 'User'"
                            @click="createFromFavorite(fav)" 
                            class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-2 sm:px-4 sm:py-2.5 rounded-lg sm:rounded-xl transition flex items-center gap-1 sm:gap-2 text-xs sm:text-sm font-bold shadow-md flex-shrink-0">
                            <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i> 
                            <span class="hidden sm:inline">ุงุณุชุฎุฏุงู</span>
                            <span class="sm:hidden">+</span>
                        </button>
                    </div>
                </div>
            </div>

            <div v-show="!showAllFavorites && favorites.length > 4" class="text-center mt-2 sm:mt-3">
                <p class="text-amber-600 text-xs font-bold">ู {{ favorites.length - 4 }} ุฃุฎุฑู...</p>
            </div>
        </div>

        <div class="bg-white rounded-2xl sm:rounded-3xl shadow-sm border border-slate-200 p-4 sm:p-6">
            <h2 class="text-lg sm:text-xl font-black text-slate-800 mb-4 sm:mb-6 flex items-center gap-2">
                <i data-lucide="list-ordered" class="text-blue-500 w-5 h-5"></i> ูุงุฆูุฉ ุงูุทูุจุงุช
            </h2>
            
            <div class="grid gap-3 sm:gap-4">
                <p v-if="requests.length === 0" class="text-slate-400 text-center py-12 sm:py-16 font-bold text-sm">ูุง ุชูุฌุฏ ุทูุจุงุช ูุณุฌูุฉ</p>
                
                <div v-for="req in filteredRequests" :key="req.id" 
                    :class="req.status === 'resolved' ? (req.ocrData?.hasError ? 'bg-red-50 border-red-200' : 'bg-slate-50 border-slate-200 grayscale') : 'bg-white border-slate-100 shadow-sm'"
                    class="border-2 rounded-xl sm:rounded-2xl p-3 sm:p-5 transition-all text-right">
                    
                    <div class="flex flex-col gap-3">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                    <h3 class="text-base sm:text-lg font-black text-slate-800">{{ req.teacherName }}</h3>
                                    <span :class="req.status === 'resolved' ? (req.ocrData?.hasError ? 'bg-red-200 text-red-700' : 'bg-slate-200 text-slate-600') : 'bg-amber-100 text-amber-700'" class="px-2 py-1 rounded-lg text-[9px] sm:text-[10px] font-black uppercase">
                                        {{ req.status === 'resolved' ? (req.ocrData?.hasError ? 'โ๏ธ ุฎุทุฃ' : 'ููุชูู') : 'ููุฏ ุงููุฑุงุฌุนุฉ' }}
                                    </span>
                                    <button 
                                        @click="toggleFavorite(req)" 
                                        :class="isFavorite(req) ? 'text-yellow-500' : 'text-slate-300 hover:text-yellow-400'"
                                        class="transition-colors"
                                        :title="isFavorite(req) ? 'ุฅุฒุงูุฉ ูู ุงูููุถูุฉ' : 'ุฅุถุงูุฉ ููููุถูุฉ'">
                                        <i :data-lucide="isFavorite(req) ? 'star' : 'star'" :class="isFavorite(req) ? 'fill-current' : ''" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                    </button>
                                </div>
                                <div class="flex flex-wrap gap-2 sm:gap-4 text-xs sm:text-sm text-slate-500 font-bold">
                                    <span class="flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3 sm:w-4 sm:h-4"></i> {{ req.teacherNumber }}</span>
                                    <span class="flex items-center gap-1"><i data-lucide="wallet" class="w-3 h-3 sm:w-4 sm:h-4 text-blue-500"></i> {{ req.accountType === 'Insta' ? 'ุฅูุณุชุง ุจุงู' : 'ูุงุด' }}</span>
                                    <span class="text-base sm:text-lg text-blue-600 font-black">{{ req.value }} ุฌ.ู</span>
                                </div>
                            </div>
                        </div>

                        <div v-if="req.status === 'resolved' && req.ocrData" class="p-3 sm:p-4 bg-white rounded-xl border-2" :class="req.ocrData.hasError ? 'border-red-300' : 'border-slate-200'">
                            <h4 class="text-xs sm:text-sm font-black mb-2 flex items-center gap-2">
                                <i data-lucide="file-text" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                ุชูุงุตูู ุงูุฅูุตุงู
                            </h4>
                            <div class="space-y-1.5 sm:space-y-2 text-[10px] sm:text-xs">
                                <div class="flex justify-between">
                                    <span class="text-slate-500">ุงููุฑุฌุน:</span>
                                    <span class="font-bold">{{ req.ocrData.reference }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-500">ุงูุชุงุฑูุฎ:</span>
                                    <span class="font-bold text-[9px] sm:text-xs">{{ req.ocrData.date }}</span>
                                </div>
                                <div class="flex justify-between" :class="req.ocrData.amountMatches ? 'text-green-600' : 'text-red-600'">
                                    <span>ุงููุจูุบ ูู ุงูุฅูุตุงู:</span>
                                    <span class="font-black">{{ req.ocrData.amount }} ุฌ {{ req.ocrData.amountMatches ? 'โ' : 'โ' }}</span>
                                </div>
                                <div class="flex justify-between" :class="req.ocrData.phoneMatches ? 'text-green-600' : 'text-red-600'">
                                    <span>ุงูุฑูู ูู ุงูุฅูุตุงู:</span>
                                    <span class="font-black">{{ req.ocrData.phone }} {{ req.ocrData.phoneMatches ? 'โ' : 'โ' }}</span>
                                </div>
                                <div v-if="req.ocrData.hasError" class="mt-2 p-2 bg-red-50 rounded text-red-700 text-[9px] sm:text-[10px] font-bold">
                                    โ๏ธ ุชุญุฐูุฑ: ุงูุจูุงูุงุช ูู ุงูุฅูุตุงู ูุง ุชุทุงุจู ุจูุงูุงุช ุงูุทูุจ
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-2 flex-wrap">
                            <template v-if="role === 'User' && req.status === 'pending'">
                                <button @click="openRequestModal(req)" class="bg-slate-100 text-slate-600 p-2 sm:p-3 rounded-xl hover:bg-blue-100 hover:text-blue-600 transition"><i data-lucide="edit" class="w-4 h-4 sm:w-5 sm:h-5"></i></button>
                                <button @click="handleDeleteRequest(req.id, req)" class="bg-slate-100 text-slate-600 p-2 sm:p-3 rounded-xl hover:bg-red-100 hover:text-red-600 transition"><i data-lucide="trash" class="w-4 h-4 sm:w-5 sm:h-5"></i></button>
                            </template>
                            <template v-if="role === 'Admin' && req.status === 'pending'">
                                <button @click="openPaymentApp(req)" class="bg-emerald-600 text-white px-4 py-2 sm:px-5 sm:py-2.5 rounded-xl hover:bg-emerald-700 transition flex items-center gap-2 font-bold shadow-md text-xs sm:text-sm">
                                    <i data-lucide="smartphone" class="w-4 h-4 sm:w-5 sm:h-5"></i> 
                                    <span>ูุชุญ {{ req.accountType === 'Insta' ? 'ุฅูุณุชุง ุจุงู' : 'ุงููุญูุธุฉ' }}</span>
                                </button>
                                <button @click="openResolveModal(req)" class="bg-blue-600 text-white px-4 py-2 sm:px-5 sm:py-2.5 rounded-xl hover:bg-blue-700 transition flex items-center gap-2 font-bold shadow-md text-xs sm:text-sm">
                                    <i data-lucide="camera" class="w-4 h-4 sm:w-5 sm:h-5"></i> ุญู ูุชูุซูู
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showLogsModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-3 sm:p-4 z-[100]" @click.self="showLogsModal = false">
        <div class="bg-white rounded-2xl sm:rounded-[2rem] p-5 sm:p-8 max-w-2xl w-full max-h-[85vh] sm:max-h-[80vh] flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-4 sm:mb-6 border-b border-slate-100 pb-3 sm:pb-4">
                <div class="flex items-center gap-2 sm:gap-3">
                    <i data-lucide="history" class="w-6 h-6 sm:w-8 sm:h-8 text-blue-600"></i>
                    <h2 class="text-xl sm:text-2xl font-black text-slate-800">ุณุฌู ุงูุนูููุงุช</h2>
                </div>
                <button @click="showLogsModal = false" class="p-2 hover:bg-slate-100 rounded-full transition text-slate-400">
                    <i data-lucide="x" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto space-y-3 sm:space-y-4 pr-2">
                <div v-for="log in sortedLogs" :key="log.id" class="bg-slate-50 border border-slate-100 rounded-xl sm:rounded-2xl p-3 sm:p-4 text-right">
                    <div class="flex justify-between mb-2 flex-wrap gap-2">
                        <span :class="log.role === 'Admin' ? 'text-red-600 bg-red-50' : 'text-blue-600 bg-blue-50'" class="px-2 py-1 rounded-md text-[9px] sm:text-[10px] font-black">{{ log.role === 'Admin' ? 'ูุฏูุฑ' : 'ูุณุชุฎุฏู' }}</span>
                        <span class="text-xs sm:text-sm font-black text-slate-700">{{ log.action }}</span>
                    </div>
                    <p class="text-xs sm:text-sm text-slate-500 font-bold leading-relaxed">{{ log.details }}</p>
                    <div class="mt-2 sm:mt-3 text-[9px] sm:text-[10px] text-slate-400 font-bold flex items-center gap-1 italic">
                        <i data-lucide="calendar" class="w-3 h-3"></i> {{ formatDate(log.timestamp) }}
                    </div>
                </div>
                <p v-if="logs.length === 0" class="text-center py-8 sm:py-10 text-slate-400 font-bold text-sm">ุงูุณุฌู ูุงุฑุบ ุญุงููุงู</p>
            </div>
        </div>
    </div>

    <div v-if="showResolveModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4 z-[110]">
        <div class="bg-white rounded-[2.5rem] p-8 max-w-md w-full shadow-2xl text-right animate-in slide-in-from-bottom-4">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="scan" class="w-10 h-10"></i>
                </div>
                <h2 class="text-2xl font-black text-slate-800">ุชูุซูู ุงูุชุญููู</h2>
                <p class="text-slate-500 font-bold mt-1 text-sm">ูู ุจุฑูุน ุฅูุตุงู ุงูุนูููุฉ ูุฅุชูุงู ุงูุทูุจ</p>
            </div>
            
            <div class="mb-8">
                <label class="group block w-full h-48 border-4 border-dashed border-slate-100 rounded-[2rem] cursor-pointer hover:border-blue-400 bg-slate-50 hover:bg-blue-50 transition-all relative overflow-hidden">
                    <div class="flex flex-col items-center justify-center h-full text-center p-4">
                        <i data-lucide="image" class="w-12 h-12 text-slate-300 group-hover:text-blue-400 mb-2 transition-colors"></i>
                        <p class="text-sm text-slate-400 group-hover:text-blue-600 font-black">ุงุฎุชุฑ ุงูุตูุฑุฉ ูู ุฌูุงุฒู</p>
                        <p v-if="selectedFileName" class="mt-2 text-blue-600 text-xs font-black truncate max-w-full px-4">{{ selectedFileName }}</p>
                    </div>
                    <input type="file" class="hidden" @change="handleImageSelection" accept="image/*" />
                </label>
            </div>

            <div v-if="isProcessingOCR" class="mb-6 flex flex-col items-center">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-12 w-12 mb-3"></div>
                <p class="text-blue-600 font-black animate-pulse">ุฌุงุฑู ูุญุต ุงูุฅูุตุงู...</p>
            </div>

            <div class="flex gap-4">
                <button @click="processOCRAndResolve" :disabled="!selectedFile || isProcessingOCR" class="flex-1 bg-blue-600 text-white px-6 py-4 rounded-2xl hover:bg-blue-700 disabled:bg-slate-200 transition font-black shadow-lg shadow-blue-200">ุชุฃููุฏ ุงูุญู</button>
                <button @click="closeResolveModal" class="flex-1 bg-slate-100 text-slate-600 px-6 py-4 rounded-2xl hover:bg-slate-200 transition font-black">ุฅูุบุงุก</button>
            </div>
        </div>
    </div>

    <div v-if="showDepositModal" class="fixed inset-0 bg-slate-900/60 flex items-center justify-center p-4 z-[100]">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl text-right">
            <h2 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-2">
                <i data-lucide="plus-circle" class="text-emerald-500"></i> ุฅูุฏุงุน ุฌุฏูุฏ
            </h2>
            <input type="number" v-model="depositAmount" placeholder="ุฃุฏุฎู ุงููุจูุบ ููุง..." class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-4 mb-6 text-right font-black focus:border-blue-500 outline-none" />
            <div class="flex gap-4">
                <button @click="handleDeposit" class="flex-1 bg-emerald-500 text-white px-6 py-4 rounded-2xl font-black hover:bg-emerald-600 shadow-lg shadow-emerald-100">ุชุฃููุฏ</button>
                <button @click="showDepositModal = false" class="flex-1 bg-slate-100 text-slate-600 px-6 py-4 rounded-2xl font-black">ุฅูุบุงุก</button>
            </div>
        </div>
    </div>

    <div v-if="showEditBalanceModal" class="fixed inset-0 bg-slate-900/60 flex items-center justify-center p-4 z-[100]">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl text-right">
            <h2 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-2">
                <i data-lucide="edit-3" class="text-blue-500"></i> ุชุนุฏูู ุงูุฑุตูุฏ
            </h2>
            <input type="number" v-model="newBalanceVal" placeholder="ุงูุฑุตูุฏ ุงูุฌุฏูุฏ..." class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-4 mb-6 text-right font-black focus:border-blue-500 outline-none" />
            <div class="flex gap-4">
                <button @click="handleUpdateBalance" class="flex-1 bg-blue-600 text-white px-6 py-4 rounded-2xl font-black hover:bg-blue-700 shadow-lg shadow-blue-100">ุชุฃููุฏ</button>
                <button @click="showEditBalanceModal = false" class="flex-1 bg-slate-100 text-slate-600 px-6 py-4 rounded-2xl font-black">ุฅูุบุงุก</button>
            </div>
        </div>
    </div>

    <div v-if="showRequestModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
        <div class="bg-white rounded-[2rem] p-8 max-w-md w-full shadow-2xl text-right relative overflow-hidden">
            <h2 class="text-2xl font-black text-slate-800 mb-6">{{ editingRequestId ? 'ุชุนุฏูู ุงูุทูุจ' : 'ุทูุจ ุฏูุน ุฌุฏูุฏ' }}</h2>
            
            <div class="space-y-4 mb-8">
                <input type="text" v-model="currentRequest.teacherName" placeholder="ุงุณู ุงููุนูู / ุงูุฌูุฉ" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-4 text-right font-bold focus:border-blue-500 outline-none" />
                <input type="text" v-model="currentRequest.teacherNumber" placeholder="ุฑูู ุงูููุจุงูู" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-4 text-right font-bold focus:border-blue-500 outline-none" />
                <select v-model="currentRequest.accountType" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-4 text-right font-bold focus:border-blue-500 outline-none appearance-none">
                    <option value="Insta">ุฅูุณุชุง ุจุงู (InstaPay)</option>
                    <option value="Wallet">ูุญูุธุฉ ุฅููุชุฑูููุฉ (Cash)</option>
                </select>
                <input type="number" v-model="currentRequest.value" placeholder="ุงููุจูุบ ุงููุทููุจ" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-6 py-4 text-right font-black text-blue-600 focus:border-blue-500 outline-none" />
            </div>

            <div class="flex gap-4">
                <button @click="handleCreateRequest" class="flex-1 bg-blue-600 text-white px-6 py-4 rounded-2xl font-black shadow-lg shadow-blue-100">{{ editingRequestId ? 'ุญูุธ' : 'ุฅุฑุณุงู' }}</button>
                <button @click="closeRequestModal" class="flex-1 bg-slate-100 text-slate-600 px-6 py-4 rounded-2xl font-black">ุชุฑุงุฌุน</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, onMounted, computed, nextTick } = Vue;

createApp({
    setup() {
        const FIREBASE_URL = 'https://pharmacy-c58d1-default-rtdb.firebaseio.com/test';
        const OCR_API_KEY = 'helloworld'; 

        const role = ref('User');
        const balance = ref(0);
        const requests = ref([]);
        const favorites = ref([]);
        const logs = ref([]);
        const displayLimit = ref(20);
        
        const showLogsModal = ref(false);
        const showResolveModal = ref(false);
        const showDepositModal = ref(false);
        const showEditBalanceModal = ref(false);
        const showRequestModal = ref(false);
        const showAllFavorites = ref(false);
        
        const selectedFile = ref(null);
        const selectedFileName = ref('');
        const isProcessingOCR = ref(false);
        const activeReqToResolve = ref(null);

        const depositAmount = ref('');
        const newBalanceVal = ref('');
        const currentRequest = ref({ teacherName: '', teacherNumber: '', accountType: 'Insta', value: '' });
        const editingRequestId = ref(null);

        const loadData = async () => {
            try {
                const [resB, resR, resF, resL] = await Promise.all([
                    fetch(`${FIREBASE_URL}/balance.json`),
                    fetch(`${FIREBASE_URL}/requests.json`),
                    fetch(`${FIREBASE_URL}/favorites.json`),
                    fetch(`${FIREBASE_URL}/logs.json`)
                ]);
                
                balance.value = await resB.json() || 0;
                
                const rData = await resR.json();
                requests.value = rData ? Object.entries(rData).map(([id, data]) => ({ id, ...data })) : [];
                
                const fData = await resF.json();
                favorites.value = fData ? Object.entries(fData).map(([id, data]) => ({ id, ...data })) : [];
                
                const lData = await resL.json();
                logs.value = lData ? Object.entries(lData).map(([id, data]) => ({ id, ...data })) : [];
                
                nextTick(() => { if (window.lucide) lucide.createIcons(); });
            } catch (e) { console.error("Load error:", e); }
        };

        const addLog = async (action, details) => {
            const log = { timestamp: new Date().toISOString(), role: role.value, action, details };
            await fetch(`${FIREBASE_URL}/logs.json`, { method: 'POST', body: JSON.stringify(log) });
            await loadData();
        };

        const toggleLogs = () => {
            showLogsModal.value = !showLogsModal.value;
            if (showLogsModal.value) {
                nextTick(() => lucide.createIcons());
            }
        };

        const shareBalance = () => {
            const text = `๐ฐ ุฑุตูุฏ ูุธุงู ุงููุฏููุนุงุช ุงูุญุงูู: ${balance.value.toFixed(2)} ุฌููู ูุตุฑู.\n๐ ุงูุชุงุฑูุฎ: ${new Date().toLocaleString('ar-EG')}`;
            if (navigator.share) {
                navigator.share({ title: 'ุฑุตูุฏ ุงููุธุงู', text: text });
            } else {
                const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
                window.open(url, '_blank');
            }
        };

        const openEditBalance = () => {
            showEditBalanceModal.value = true;
            newBalanceVal.value = balance.value.toString();
            nextTick(() => lucide.createIcons());
        };

        const handleUpdateBalance = async () => {
            const newVal = parseFloat(newBalanceVal.value);
            if (isNaN(newVal)) return;
            
            if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุชุบููุฑ ุงูุฑุตูุฏ ุฅูู ${newVal} ุฌูููุ`)) return;
            
            await fetch(`${FIREBASE_URL}/balance.json`, { method: 'PUT', body: JSON.stringify(newVal) });
            await addLog('ุชุนุฏูู ุงูุฑุตูุฏ', `ุชู ุชุบููุฑ ุงูุฑุตูุฏ ูุฏููุงู ุฅูู ${newVal} ุฌ`);
            showEditBalanceModal.value = false;
            await loadData();
        };

        const handleDeposit = async () => {
            const amount = parseFloat(depositAmount.value);
            if (!amount || amount <= 0) return;
            const nb = balance.value + amount;
            await fetch(`${FIREBASE_URL}/balance.json`, { method: 'PUT', body: JSON.stringify(nb) });
            await addLog('ุฅูุฏุงุน ุฑุตูุฏ', `ุฅุถุงูุฉ ูุจูุบ ${amount} ุฌ`);
            showDepositModal.value = false;
            depositAmount.value = '';
            await loadData();
        };

        const openRequestModal = (req = null) => {
            if (req) {
                currentRequest.value = { ...req, value: req.value.toString() };
                editingRequestId.value = req.id;
            } else {
                currentRequest.value = { teacherName: '', teacherNumber: '', accountType: 'Insta', value: '' };
                editingRequestId.value = null;
            }
            showRequestModal.value = true;
            nextTick(() => lucide.createIcons());
        };

        const closeRequestModal = () => { showRequestModal.value = false; editingRequestId.value = null; };

        const handleCreateRequest = async () => {
            if (!currentRequest.value.teacherName || !currentRequest.value.value) return;
            const data = { 
                ...currentRequest.value, 
                value: parseFloat(currentRequest.value.value), 
                status: 'pending', 
                createdAt: new Date().toISOString() 
            };
            
            if (editingRequestId.value) {
                await fetch(`${FIREBASE_URL}/requests/${editingRequestId.value}.json`, { method: 'PUT', body: JSON.stringify(data) });
            } else {
                await fetch(`${FIREBASE_URL}/requests.json`, { method: 'POST', body: JSON.stringify(data) });
            }
            
            await addLog(editingRequestId.value ? 'ุชุนุฏูู ุทูุจ' : 'ุฅูุดุงุก ุทูุจ', `ุงููุนูู: ${data.teacherName} ุจูุจูุบ ${data.value}`);
            closeRequestModal();
            await loadData();
        };

        const handleDeleteRequest = async (id, req) => {
            if (!confirm('ุญุฐู ูุฐุง ุงูุทูุจ ููุงุฆูุงูุ')) return;
            await fetch(`${FIREBASE_URL}/requests/${id}.json`, { method: 'DELETE' });
            await addLog('ุญุฐู ุทูุจ', `ุชู ุญุฐู ุทูุจ ุงููุนูู: ${req.teacherName}`);
            await loadData();
        };

        const isFavorite = (req) => {
            return favorites.value.some(fav => 
                fav.teacherName === req.teacherName && 
                fav.teacherNumber === req.teacherNumber
            );
        };

        const toggleFavorite = async (req) => {
            const existingFav = favorites.value.find(fav => 
                fav.teacherName === req.teacherName && 
                fav.teacherNumber === req.teacherNumber
            );

            if (existingFav) {
                await fetch(`${FIREBASE_URL}/favorites/${existingFav.id}.json`, { method: 'DELETE' });
                await addLog('ุฅุฒุงูุฉ ูู ุงูููุถูุฉ', `ุชูุช ุฅุฒุงูุฉ ${req.teacherName} ูู ุงูููุถูุฉ`);
            } else {
                const favData = {
                    teacherName: req.teacherName,
                    teacherNumber: req.teacherNumber,
                    accountType: req.accountType,
                    value: req.value,
                    addedAt: new Date().toISOString()
                };
                await fetch(`${FIREBASE_URL}/favorites.json`, { method: 'POST', body: JSON.stringify(favData) });
                await addLog('ุฅุถุงูุฉ ููููุถูุฉ', `ุชูุช ุฅุถุงูุฉ ${req.teacherName} ููููุถูุฉ`);
            }
            
            await loadData();
        };

        const removeFavorite = async (favId) => {
            if (!confirm('ุฅุฒุงูุฉ ูู ุงูููุถูุฉุ')) return;
            await fetch(`${FIREBASE_URL}/favorites/${favId}.json`, { method: 'DELETE' });
            await loadData();
        };

        const createFromFavorite = (fav) => {
            currentRequest.value = {
                teacherName: fav.teacherName,
                teacherNumber: fav.teacherNumber,
                accountType: fav.accountType,
                value: fav.value.toString()
            };
            editingRequestId.value = null;
            showRequestModal.value = true;
            nextTick(() => lucide.createIcons());
        };

        const openPaymentApp = (req) => {
            const phoneNumber = req.teacherNumber.replace(/\s/g, '');
            
            if (req.accountType === 'Insta') {
                // ูุญุงููุฉ ูุชุญ ุชุทุจูู InstaPay
                // ูููู ุงุณุชุฎุฏุงู deep link ุฅุฐุง ูุงู ูุชุงุญุงู
                const instaPayUrl = `instapay://send?phone=${phoneNumber}&amount=${req.value}`;
                const fallbackUrl = `https://instapay.com.eg`; // URL ุงุญุชูุงุทู
                
                // ูุญุงููุฉ ูุชุญ ุงูุชุทุจูู
                const link = document.createElement('a');
                link.href = instaPayUrl;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // ุฅุฐุง ูุดู ูุชุญ ุงูุชุทุจููุ ุนุฑุถ ุฑุณุงูุฉ ูุน ุงูุฑูู
                setTimeout(() => {
                    if (confirm(`ูุชุญ ุชุทุจูู ุฅูุณุชุง ุจุงูุ\n\nุงูุฑูู: ${phoneNumber}\nุงููุจูุบ: ${req.value} ุฌููู\n\nุงูุณุฎ ุงูุฑูู ููุญุงูุธุฉุ`)) {
                        navigator.clipboard.writeText(phoneNumber).then(() => {
                            alert(`โ ุชู ูุณุฎ ุงูุฑูู: ${phoneNumber}\n\nุงูุชุญ ุชุทุจูู ุฅูุณุชุง ุจุงู ูุฏููุงู ูุงูุตู ุงูุฑูู`);
                        }).catch(() => {
                            alert(`ุงูุฑูู: ${phoneNumber}\nุงููุจูุบ: ${req.value} ุฌููู`);
                        });
                    }
                }, 500);
                
            } else {
                // ูุชุญ ุชุทุจูู ุงููุญูุธุฉ (Vodafone Cash / Orange Cash / etc)
                const walletUrl = `tel:${phoneNumber}`;
                
                if (confirm(`ูุชุญ ุชุทุจูู ุงููุญูุธุฉุ\n\nุงูุฑูู: ${phoneNumber}\nุงููุจูุบ: ${req.value} ุฌููู\n\nูู ุชุฑูุฏ ูุณุฎ ุงูุฑูู ููุญุงูุธุฉุ`)) {
                    navigator.clipboard.writeText(phoneNumber).then(() => {
                        alert(`โ ุชู ูุณุฎ ุงูุฑูู: ${phoneNumber}\n\nุงูุชุญ ุชุทุจูู ุงููุญูุธุฉ ุงูุฅููุชุฑูููุฉ ูุฏููุงู`);
                    }).catch(() => {
                        alert(`ุงูุฑูู: ${phoneNumber}\nุงููุจูุบ: ${req.value} ุฌููู`);
                    });
                }
            }
            
            addLog('ูุชุญ ุชุทุจูู ุงูุฏูุน', `ูุญุงููุฉ ูุชุญ ${req.accountType === 'Insta' ? 'ุฅูุณุชุง ุจุงู' : 'ุงููุญูุธุฉ'} ูููุนูู ${req.teacherName} - ${phoneNumber}`);
        };

        const openResolveModal = (req) => { 
            activeReqToResolve.value = req; 
            showResolveModal.value = true; 
            nextTick(() => lucide.createIcons()); 
        };
        
        const closeResolveModal = () => { 
            showResolveModal.value = false; 
            selectedFile.value = null; 
            selectedFileName.value = ''; 
        };

        const handleImageSelection = (e) => {
            const f = e.target.files[0];
            if (f) { 
                selectedFile.value = f; 
                selectedFileName.value = f.name; 
            }
        };

        const processOCRAndResolve = async () => {
            if (!selectedFile.value) return;
            isProcessingOCR.value = true;
            const reader = new FileReader();
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                const fd = new FormData();
                fd.append('base64Image', 'data:image/png;base64,' + base64);
                fd.append('apikey', OCR_API_KEY);
                try {
                    const res = await fetch('https://api.ocr.space/parse/image', { method: 'POST', body: fd });
                    const json = await res.json();
                    const text = json.ParsedResults?.[0]?.ParsedText || '';
                    
                    // ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ูู ูุต OCR
                    const amountMatch = text.match(/(\d+)\s*EGP/);
                    const ocrAmount = amountMatch ? parseFloat(amountMatch[1]) : 0;
                    
                    const phoneMatch = text.match(/01\s*\d{2}\s*\d{3}\s*\d{4}/);
                    const ocrPhone = phoneMatch ? phoneMatch[0].replace(/\s/g, '') : '';
                    
                    const referenceMatch = text.match(/\d{12}/);
                    const ocrReference = referenceMatch ? referenceMatch[0] : 'N/A';
                    
                    const dateMatch = text.match(/(\d{1,2}\s+\w+\s+\d{4}\s+\d{1,2}:\d{2}\s+[AP]M)/);
                    const ocrDate = dateMatch ? dateMatch[1] : new Date().toLocaleString('ar-EG');
                    
                    // ุงูุชุญูู ูู ุชุทุงุจู ุงูุจูุงูุงุช
                    const requestPhone = activeReqToResolve.value.teacherNumber.replace(/\s/g, '');
                    const amountMatches = ocrAmount === activeReqToResolve.value.value;
                    const phoneMatches = ocrPhone === requestPhone;
                    const hasError = !amountMatches || !phoneMatches;
                    
                    const extracted = {
                        reference: ocrReference,
                        amount: ocrAmount,
                        phone: ocrPhone,
                        date: ocrDate,
                        requestedAmount: activeReqToResolve.value.value,
                        requestedPhone: activeReqToResolve.value.teacherNumber,
                        amountMatches,
                        phoneMatches,
                        hasError
                    };

                    // ุชุฃููุฏ ุงูุนูููุฉ
                    const confirmMsg = hasError 
                        ? `โ๏ธ ุชุญุฐูุฑ: ุชู ุงูุชุดุงู ุนุฏู ุชุทุงุจู!\n\n` +
                          `${!amountMatches ? `โ ุงููุจูุบ: ${ocrAmount} ุฌ (ุงููุทููุจ: ${activeReqToResolve.value.value} ุฌ)\n` : ''}` +
                          `${!phoneMatches ? `โ ุงูุฑูู: ${ocrPhone} (ุงููุทููุจ: ${requestPhone})\n` : ''}` +
                          `\nูู ุชุฑูุฏ ุงููุชุงุจุนุฉ ุฑุบู ุฐููุ`
                        : `โ ุชู ุงูุชุญูู ุจูุฌุงุญ!\n\n` +
                          `ุงููุจูุบ: ${ocrAmount} ุฌ\n` +
                          `ุงูุฑูู: ${ocrPhone}\n` +
                          `ุงููุฑุฌุน: ${ocrReference}\n\n` +
                          `ูู ุชุฑูุฏ ุฅุชูุงู ุงูุนูููุฉ ูุฎุตู ุงููุจูุบ ูู ุงูุฑุตูุฏุ`;
                    
                    if (!confirm(confirmMsg)) {
                        isProcessingOCR.value = false;
                        return;
                    }

                    const newBal = balance.value - activeReqToResolve.value.value;
                    await fetch(`${FIREBASE_URL}/balance.json`, { method: 'PUT', body: JSON.stringify(newBal) });
                    await fetch(`${FIREBASE_URL}/requests/${activeReqToResolve.value.id}.json`, { 
                        method: 'PATCH', 
                        body: JSON.stringify({ status: 'resolved', ocrData: extracted }) 
                    });
                    
                    const logDetails = hasError 
                        ? `ุฏูุน ${activeReqToResolve.value.value} ุฌ ูููุนูู ${activeReqToResolve.value.teacherName} ูุน ุฃุฎุทุงุก. ุงููุฑุฌุน: ${ocrReference}`
                        : `ุฏูุน ${activeReqToResolve.value.value} ุฌ ูููุนูู ${activeReqToResolve.value.teacherName}. ุงููุฑุฌุน: ${ocrReference}`;
                    
                    await addLog(hasError ? 'ุชู ุงูุฏูุน (ุฎุทุฃ)' : 'ุชู ุงูุฏูุน (OCR)', logDetails);
                    closeResolveModal();
                    await loadData();
                } catch (e) { 
                    alert('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุฎุฏูุฉ OCR'); 
                    console.error('OCR Error:', e);
                }
                finally { isProcessingOCR.value = false; }
            };
            reader.readAsDataURL(selectedFile.value);
        };

        const sortedLogs = computed(() => [...logs.value].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
        const filteredRequests = computed(() => {
            return [...requests.value]
                .sort((a, b) => (a.status === 'pending' ? -1 : 1))
                .slice(0, displayLimit.value);
        });

        onMounted(() => {
            const params = new URLSearchParams(window.location.search);
            role.value = params.get('Admin') !== null ? 'Admin' : 'User';
            loadData();
            setInterval(loadData, 20000);
        });

        return {
            role, balance, requests, logs, favorites, displayLimit,
            showLogsModal, showResolveModal, showDepositModal, showEditBalanceModal, showRequestModal, showAllFavorites,
            selectedFile, selectedFileName, isProcessingOCR,
            depositAmount, newBalanceVal, currentRequest, editingRequestId,
            handleDeposit, openEditBalance, handleUpdateBalance, toggleLogs, shareBalance,
            openRequestModal, closeRequestModal, handleCreateRequest, handleDeleteRequest,
            openResolveModal, closeResolveModal, handleImageSelection, processOCRAndResolve,
            isFavorite, toggleFavorite, removeFavorite, createFromFavorite, openPaymentApp,
            sortedLogs, filteredRequests,
            formatDate: (ts) => new Date(ts).toLocaleString('ar-EG')
        }
    }
}).mount('#app');
</script>
</body>
</html>
